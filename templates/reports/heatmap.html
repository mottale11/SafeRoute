{% extends 'base_authenticated.html' %}
{% load static %}

{% block extra_css %}
<link rel="shortcut icon" href="{% static 'images/SR_Logo.png' %}" type="image/x-icon">
{% endblock %}

{% block title %}Safety Heatmap - SafeRoute{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    #heatmap {
        height: 600px;
        width: 100%;
        border-radius: 15px;
        z-index: 1;
    }
    .floating-report-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        box-shadow: 0 4px 15px rgba(199, 35, 117, 0.4);
        align-items: center;
        justify-content: center;
        display: flex;
    }
    @media (max-width: 768px) {
        #heatmap {
            height: 400px;
        }
        .floating-report-btn {
            bottom: 20px;
            right: 20px;
            width: 30px;
            height: 60px;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <!-- Filters Panel -->
        <div class="col-md-3 mb-4 mb-md-0">
            <div class="filters-panel">
                <h5>Filters</h5>
                
                <form method="get" id="filterForm">
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-control" onchange="this.form.submit()">
                            <option value="">All Categories</option>
                            <option value="theft" {% if selected_category == 'theft' %}selected{% endif %}>Theft</option>
                            <option value="harassment" {% if selected_category == 'harassment' %}selected{% endif %}>Harassment</option>
                            <option value="assault" {% if selected_category == 'assault' %}selected{% endif %}>Assault</option>
                            <option value="road_danger" {% if selected_category == 'road_danger' %}selected{% endif %}>Road Danger</option>
                            <option value="fraud" {% if selected_category == 'fraud' %}selected{% endif %}>Fraud/Scam</option>
                            <option value="violence" {% if selected_category == 'violence' %}selected{% endif %}>Violence</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Severity</label>
                        <select name="severity" class="form-control" onchange="this.form.submit()">
                            <option value="">All Severities</option>
                            <option value="high" {% if selected_severity == 'high' %}selected{% endif %}>High Risk</option>
                            <option value="moderate" {% if selected_severity == 'moderate' %}selected{% endif %}>Moderate</option>
                            <option value="low" {% if selected_severity == 'low' %}selected{% endif %}>Low Risk</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Time Period</label>
                        <select name="time" class="form-control" onchange="this.form.submit()">
                            <option value="all" {% if selected_time == 'all' %}selected{% endif %}>All Time</option>
                            <option value="24h" {% if selected_time == '24h' %}selected{% endif %}>Past 24 Hours</option>
                            <option value="week" {% if selected_time == 'week' %}selected{% endif %}>Past Week</option>
                            <option value="month" {% if selected_time == 'month' %}selected{% endif %}>Past Month</option>
                        </select>
                    </div>
                </form>
                
                <!-- Legend -->
                <div class="heatmap-legend mt-4">
                    <h6>Legend</h6>
                    <div class="legend-item">
                        <div class="legend-color red"></div>
                        <span>High Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color orange"></div>
                        <span>Moderate Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color blue"></div>
                        <span>Low Risk</span>
                    </div>
                </div>
            </div>
            
            <!-- Saved Zones Section (for authenticated users) -->
            {% if user.is_authenticated and user_saved_zones %}
            <div id="saved-zones" class="mt-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-star me-2"></i>Your Saved Zones</h5>
                    </div>
                    <div class="card-body">
                        <div class="saved-zones-list">
                            {% for zone in user_saved_zones %}
                            <div class="saved-zone-item mb-3">
                                <h6 class="mb-1"><i class="fas fa-map-pin text-primary me-1"></i>{{ zone.name }}</h6>
                                <p class="small text-muted mb-2">
                                    <i class="fas fa-ruler-combined me-1"></i>Radius: {{ zone.radius }} km
                                </p>
                                <button class="btn btn-sm btn-primary w-100" onclick="focusZone({{ zone.latitude|floatformat:6 }}, {{ zone.longitude|floatformat:6 }}, {{ zone.radius|floatformat:2 }})">
                                    <i class="fas fa-map-marker-alt me-1"></i>Focus on Map
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Map -->
        <div class="col-md-9">
            <div id="heatmap"></div>
        </div>
    </div>
</div>

<!-- Floating Report Button -->
{% if user.is_authenticated %}
<a href="{% url 'reports:submit_report' %}" class="btn btn-primary floating-report-btn" title="Submit Report">
    <i class="bi bi-patch-plus" style="font-size: 40px;"></i>
</a>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
// Initialize map
const map = L.map('heatmap', {
    zoomControl: true,
    scrollWheelZoom: true
}).setView([-1.2921, 36.8219], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Get incidents data from template
const incidents = {{ incidents|safe }};

// Create heatmap data
const heatmapData = incidents.map(incident => [
    incident.latitude,
    incident.longitude,
    0.5 // intensity
]);

// Add heatmap layer
if (heatmapData.length > 0) {
    L.heatLayer(heatmapData, {
        radius: 25,
        blur: 15,
        maxZoom: 17,
        gradient: {
            0.0: 'blue',
            0.5: 'orange',
            1.0: 'red'
        }
    }).addTo(map);
}

// Add markers for each incident
incidents.forEach(incident => {
    const severityColor = incident.severity === 'high' ? 'red' : 
                         incident.severity === 'moderate' ? 'orange' : 'blue';
    
    const marker = L.circleMarker([incident.latitude, incident.longitude], {
        radius: 8,
        fillColor: severityColor,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(map);
    
    marker.bindPopup(`
        <div style="min-width: 200px;">
            <h6 style="color: #C72375; margin-bottom: 0.5rem;">${incident.title}</h6>
            <p class="mb-1"><strong>Category:</strong> ${incident.category}</p>
            <p class="mb-1"><strong>Location:</strong> ${incident.location_name || 'Not specified'}</p>
            <p class="mb-1"><strong>Date:</strong> ${new Date(incident.incident_date).toLocaleDateString()}</p>
            <a href="${incident.url}" class="btn btn-sm btn-primary mt-2 w-100">View Full Report</a>
        </div>
    `);
});

// Add saved zones as circles
const savedZones = {{ saved_zones|safe }};
const savedZoneLayers = [];

if (savedZones && savedZones.length > 0) {
    savedZones.forEach(zone => {
        const circle = L.circle([zone.latitude, zone.longitude], {
            radius: zone.radius * 1000, // Convert km to meters
            color: '#C72375',
            fillColor: '#C72375',
            fillOpacity: 0.2,
            weight: 2
        }).addTo(map).bindPopup(`<strong>${zone.name}</strong><br>Radius: ${zone.radius} km`);
        savedZoneLayers.push({circle: circle, zone: zone});
    });
}

// Function to focus on a saved zone
function focusZone(lat, lng, radius) {
    map.setView([lat, lng], 14);
    // Highlight the zone
    if (savedZoneLayers && savedZoneLayers.length > 0) {
        savedZoneLayers.forEach(item => {
            if (Math.abs(item.zone.latitude - lat) < 0.0001 && Math.abs(item.zone.longitude - lng) < 0.0001) {
                item.circle.setStyle({
                    fillOpacity: 0.4,
                    weight: 3,
                    color: '#FF7F50'
                });
                item.circle.openPopup();
                setTimeout(() => {
                    item.circle.setStyle({
                        fillOpacity: 0.2,
                        weight: 2,
                        color: '#C72375'
                    });
                }, 3000);
            }
        });
    }
}
</script>
{% endblock %}
