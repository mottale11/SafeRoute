{% extends 'base_authenticated.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Submit Incident Report - SafeRoute{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h3>Submit Incident Report</h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="reportForm">
                        {% csrf_token %}
                        
                        <!-- Incident Details -->
                        <h5 class="mb-3 mt-4">A. Incident Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.title|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.category|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.incident_date|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.severity|as_crispy_field }}
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.description|as_crispy_field }}
                        </div>

                        <!-- Location -->
                        <h5 class="mb-3 mt-4">B. Location</h5>
                        <div id="map"></div>
                        <button type="button" class="btn btn-secondary mb-3" onclick="getCurrentLocation()">
                            <i class="fas fa-location-arrow"></i> Use My Current Location
                        </button>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.latitude|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.longitude|as_crispy_field }}
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.location_name|as_crispy_field }}
                        </div>

                        <!-- Upload Section -->
                        <h5 class="mb-3 mt-4">C. Upload Section</h5>
                        <div class="alert alert-info">
                            <strong>Important:</strong> 
                            <ul class="mb-0">
                                <li>Upload suspect/offender photos (optional) - Faces will be auto-blurred by default</li>
                                <li>Upload location/venue photos (recommended) - Helps others identify the area</li>
                                <li>False reporting may lead to account suspension</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Upload Images</label>
                            <input type="file" name="images" class="form-control" multiple accept="image/*">
                            <small class="form-text text-muted">You can upload multiple images</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image Type</label>
                            <select name="image_type" class="form-control">
                                <option value="location">Location Photo</option>
                                <option value="suspect">Suspect/Offender Photo</option>
                                <option value="evidence">Other Evidence</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="autoBlur" checked>
                            <label class="form-check-label" for="autoBlur">
                                Auto-blur faces in images
                            </label>
                        </div>

                        <!-- Evidence -->
                        <h5 class="mb-3 mt-4">D. Additional Evidence (Optional)</h5>
                        <div class="mb-3">
                            <label class="form-label">Videos</label>
                            <input type="file" name="videos" class="form-control" multiple accept="video/*">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Audio Recordings</label>
                            <input type="file" name="audio" class="form-control" multiple accept="audio/*">
                        </div>

                        <!-- Submit -->
                        <div class="alert alert-warning mt-4">
                            <strong>Warning:</strong> False reporting may lead to account suspension. Please provide accurate information.
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker;
let defaultLat = -1.2921; // Nairobi coordinates
let defaultLng = 36.8219;

// Initialize map
map = L.map('map').setView([defaultLat, defaultLng], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// Add marker
marker = L.marker([defaultLat, defaultLng], {draggable: true}).addTo(map);

// Update coordinates when marker is dragged
marker.on('dragend', function(e) {
    const pos = marker.getLatLng();
    document.getElementById('id_latitude').value = pos.lat.toFixed(6);
    document.getElementById('id_longitude').value = pos.lng.toFixed(6);
});

// Update marker when clicking on map
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    marker.setLatLng([lat, lng]);
    document.getElementById('id_latitude').value = lat.toFixed(6);
    document.getElementById('id_longitude').value = lng.toFixed(6);
});

// Get current location
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            document.getElementById('id_latitude').value = lat.toFixed(6);
            document.getElementById('id_longitude').value = lng.toFixed(6);
        });
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

// Initialize with form values if they exist
const formLat = document.getElementById('id_latitude').value;
const formLng = document.getElementById('id_longitude').value;
if (formLat && formLng) {
    map.setView([formLat, formLng], 15);
    marker.setLatLng([formLat, formLng]);
}
</script>
{% endblock %}

